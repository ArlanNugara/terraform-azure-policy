module "pv6_sql_servers_on_machines_should_have_vulnerability_findings_resolved_policy" {
  source                         = "./modules/generic_policy_module"
  policy_definition_name         = "${var.client}-SQL servers on machines should have vulnerability findings resolved"
  policy_definition_display_name = "${var.client}-SQL servers on machines should have vulnerability findings resolved"
  policy_definition_description  = "SQL vulnerability assessment scans your database for security vulnerabilities, and exposes any deviations from best practices such as misconfigurations, excessive permissions, and unprotected sensitive data. Resolving the vulnerabilities found can greatly improve your database security posture."
  policy_definition_metadata = jsonencode(
    {
      "category" : "Security Center"
    }
  )

  policy_definition_rule = jsonencode(
    {
      "if" : {
        "field" : "type",
        "in" : [
          "Microsoft.Compute/virtualMachines",
          "Microsoft.HybridCompute/machines"
        ]
      },
      "then" : {
        "effect" : "AuditIfNotExists",
        "details" : {
          "type" : "Microsoft.Security/assessments",
          "name" : "f97aa83c-9b63-4f9a-99f6-b22c4398f936",
          "existenceCondition" : {
            "field" : "Microsoft.Security/assessments/status.code",
            "in" : [
              "NotApplicable",
              "Healthy"
            ]
          }
        }
      }
    }
  )
}
